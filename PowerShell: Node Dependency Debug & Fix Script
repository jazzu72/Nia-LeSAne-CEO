# =========================================
# Node Dependency Lockfile Debug Script
# =========================================

Write-Host "üîç Starting Node dependency diagnostics..." -ForegroundColor Cyan

$root = Get-Location

$packageJson = Join-Path $root "package.json"
$npmLock     = Join-Path $root "package-lock.json"
$yarnLock    = Join-Path $root "yarn.lock"
$shrinkwrap  = Join-Path $root "npm-shrinkwrap.json"

if (-not (Test-Path $packageJson)) {
    Write-Error "‚ùå package.json not found. This repo is not a Node project."
    exit 1
}

Write-Host "‚úÖ package.json found"

$lockFiles = @($npmLock, $yarnLock, $shrinkwrap) | Where-Object { Test-Path $_ }

if ($lockFiles.Count -gt 1) {
    Write-Error "‚ùå Multiple lock files detected. Choose ONE package manager."
    $lockFiles | ForEach-Object { Write-Host " - $($_)" }
    exit 1
}

if ($lockFiles.Count -eq 0) {
    Write-Warning "‚ö†Ô∏è No dependency lock file found."

    if (Get-Command npm -ErrorAction SilentlyContinue) {
        Write-Host "üì¶ Generating package-lock.json using npm..."
        npm install --package-lock-only --ignore-scripts

        if (-not (Test-Path $npmLock)) {
            Write-Error "‚ùå npm failed to generate package-lock.json"
            exit 1
        }

        Write-Host "‚úÖ package-lock.json created"
    }
    else {
        Write-Error "‚ùå npm is not available in PATH"
        exit 1
    }
}
else {
    Write-Host "‚úÖ Lock file detected:"
    $lockFiles | ForEach-Object { Write-Host " - $($_)" }
}

Write-Host "üöÄ Dependency diagnostics complete" -ForegroundColor Green
